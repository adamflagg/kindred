name: CI - Tests & Linting

on:
  # Allow manual triggering
  workflow_dispatch:
  # Run on pushes to main only (feature branches use pull_request trigger)
  push:
    branches:
      - main
    tags-ignore:
      - '**'  # Skip CI on tag pushes (already tested on branch)
  # Run on pull requests targeting main (covers all feature branch pushes)
  # Note: No paths-ignore here - we need CI Summary to always report for branch protection
  # The detect-changes job handles optimization by skipping jobs when only docs change
  pull_request:
    branches: [main]

# Permissions needed for Dependabot PRs (paths-filter needs to read commits)
permissions:
  contents: read
  pull-requests: read

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Validate commit message format (conventional commits with scopes)
  commit-lint:
    name: Commit Message Lint
    runs-on: ubuntu-latest
    # Skip for Dependabot PRs (uses its own commit format)
    if: github.actor != 'dependabot[bot]'
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Full history for commit range

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '22'

    - name: Install commitlint
      run: npm install --save-dev @commitlint/cli @commitlint/config-conventional

    - name: Validate commits
      run: |
        # For PRs, check all commits in the PR
        # For pushes, check just the pushed commits
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose
        else
          # For direct pushes, check the last commit
          # Handle initial commit (no parent) gracefully
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            npx commitlint --from HEAD~1 --to HEAD --verbose
          else
            echo "⚠️ Initial commit detected (no parent) - skipping commit lint"
            echo "   Commit message: $(git log -1 --format=%s)"
          fi
        fi

  # Detect what changed to optimize CI runs
  detect-changes:
    name: Detect Changed Files
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      tests: ${{ steps.filter.outputs.tests }}
      scripts: ${{ steps.filter.outputs.scripts }}
      docker: ${{ steps.filter.outputs.docker }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Check for file changes
      uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          backend:
            - 'api/**/*.py'
            - 'bunking/**/*.py'
            - 'campminder/**'
            - 'pocketbase/**'
            - 'scripts/**/*.py'
            - 'pyproject.toml'
            - 'ruff.toml'
            - 'uv.lock'
            - 'go.mod'
            - 'go.sum'
            - '.golangci.yml'
          frontend:
            - 'frontend/**'
            - 'package*.json'
            - 'tsconfig*.json'
          tests:
            - 'tests/**'
            - 'conftest.py'
            - 'frontend/src/**/*.test.*'
            - 'frontend/src/**/*.spec.*'
            - 'pocketbase/**/*_test.go'
          scripts:
            - 'scripts/**/*.sh'
            - '.githooks/**'
            - '.shellcheckrc'
          docker:
            - 'Dockerfile'
            - 'docker/**'
            - '.hadolint.yaml'

  # Secret scanning (runs unconditionally on all pushes/PRs)
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Full history for better scanning

    - name: Install gitleaks
      run: |
        curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.22.1/gitleaks_8.22.1_linux_x64.tar.gz | \
          sudo tar xz -C /usr/local/bin gitleaks

    - name: Run Gitleaks
      run: gitleaks detect --source . --config .gitleaks.toml --verbose

  # Python linting (parallel with other lint jobs)
  python-lint:
    name: Python Lint
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.14'

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true

    - name: Install Python dependencies
      run: uv sync --frozen

    - name: Python formatting check
      run: uv run ruff format --check .

    - name: Python linting
      run: uv run ruff check .

    - name: Python type check (mypy)
      run: uv run mypy . --explicit-package-bases

    - name: Security audit (pip-audit)
      run: uv run pip-audit --desc || echo "::warning::pip-audit found vulnerabilities"

    - name: JSON config validation
      run: |
        echo "Validating JSON config files..."
        for f in config/*.json bunking/*.json; do
          if [ -f "$f" ]; then
            python -m json.tool "$f" > /dev/null && echo "✓ $f" || { echo "✗ $f is invalid JSON"; exit 1; }
          fi
        done

  # Go linting (parallel with other lint jobs)
  go-lint:
    name: Go Lint
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.backend == 'true' ||
      needs.detect-changes.outputs.scripts == 'true' ||
      needs.detect-changes.outputs.docker == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: pocketbase/package-lock.json

    - name: Setup Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.24'
        cache: true
        cache-dependency-path: pocketbase/go.sum

    - name: Cache apt packages
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: shellcheck
        version: shellcheck-v1

    - name: Install govulncheck
      run: go install golang.org/x/vuln/cmd/govulncheck@latest

    - name: Go formatting check
      if: needs.detect-changes.outputs.backend == 'true'
      run: |
        if [ -n "$(gofmt -l pocketbase)" ]; then
          echo "Go files need formatting. Please run: gofmt -w pocketbase"
          gofmt -d pocketbase
          exit 1
        fi

    - name: Go vet
      if: needs.detect-changes.outputs.backend == 'true'
      working-directory: ./pocketbase
      run: go vet ./...

    - name: Go linting
      if: needs.detect-changes.outputs.backend == 'true'
      uses: golangci/golangci-lint-action@v9
      with:
        version: v2.8.0
        working-directory: pocketbase
        args: --config ../.golangci.yml

    - name: Go build check
      if: needs.detect-changes.outputs.backend == 'true'
      working-directory: ./pocketbase
      run: go build -o /dev/null ./...

    - name: Security audit (govulncheck)
      if: needs.detect-changes.outputs.backend == 'true'
      working-directory: ./pocketbase
      run: govulncheck ./... || echo "::warning::govulncheck found vulnerabilities"

    # PocketBase JS linting (migrations and hooks)
    - name: Install PocketBase JS linting dependencies
      if: needs.detect-changes.outputs.backend == 'true'
      working-directory: ./pocketbase
      run: npm ci

    - name: PocketBase JS linting
      if: needs.detect-changes.outputs.backend == 'true'
      working-directory: ./pocketbase
      run: npm run lint

    # Shell script linting (warning+ severity - info is too noisy)
    - name: Shell script linting (shellcheck)
      if: needs.detect-changes.outputs.scripts == 'true' || needs.detect-changes.outputs.backend == 'true' || needs.detect-changes.outputs.docker == 'true'
      run: |
        echo "Checking shell scripts..."
        shellcheck --severity=warning scripts/*.sh scripts/**/*.sh .githooks/* docker/*.sh frontend/*.sh tests/shell/*.sh

  # Frontend linting (parallel with other lint jobs)
  frontend-lint:
    name: Frontend Lint
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci

    - name: TypeScript type check
      working-directory: ./frontend
      run: npm run type-check

    - name: TypeScript linting
      working-directory: ./frontend
      run: npm run lint

    - name: Security audit (npm)
      working-directory: ./frontend
      run: npm audit --audit-level=high || echo "::warning::npm audit found vulnerabilities"

  # Docker linting (parallel with other lint jobs)
  docker-lint:
    name: Docker Lint
    needs: detect-changes
    if: needs.detect-changes.outputs.docker == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    # Dockerfile linting (stdin, no mounts - avoids self-hosted runner volume mount issues)
    - name: Dockerfile linting (hadolint)
      run: docker run --rm -i hadolint/hadolint /bin/hadolint --ignore DL3008 - < Dockerfile

    # Caddyfile validation (stdin, no mounts - avoids self-hosted runner volume mount issues)
    - name: Caddyfile validation
      run: |
        docker run --rm -i caddy:2 caddy adapt --adapter caddyfile --config - < docker/Caddyfile > /dev/null
        docker run --rm -i caddy:2 caddy adapt --adapter caddyfile --config - < frontend/Caddyfile > /dev/null

  # Run tests in parallel with lint jobs
  tests:
    name: Run Tests
    needs: detect-changes
    # Run when relevant code changed (backend, frontend, or tests)
    if: |
      needs.detect-changes.outputs.backend == 'true' ||
      needs.detect-changes.outputs.frontend == 'true' ||
      needs.detect-changes.outputs.tests == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.14'

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Setup Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.24'
        cache: true
        cache-dependency-path: pocketbase/go.sum

    # Backend tests (Python) - uv manages dependencies
    - name: Install Python dependencies
      run: uv sync --frozen

    - name: Create logs directory
      run: mkdir -p logs

    - name: Run Python unit tests (no external deps)
      env:
        SKIP_POCKETBASE_TESTS: true
      run: uv run pytest tests/unit/ -v --tb=short --ignore=tests/unit/api/

    # Backend tests (Go) - tools pre-installed
    - name: Run Go tests
      working-directory: ./pocketbase
      run: go test ./... -v

    # Migration smoke test - catches self-reference, dependency, and schema issues
    - name: Migration smoke test (fresh database)
      working-directory: ./pocketbase
      run: |
        echo "Building PocketBase..."
        go build -o pocketbase .

        echo "Testing migrations on fresh database..."
        # Use local test data directory so PocketBase discovers migrations via default path:
        # ./pb_test_data/../pb_migrations = ./pb_migrations
        rm -rf ./pb_test_data
        mkdir -p ./pb_test_data
        echo "Migrations directory contents:"
        ls -la pb_migrations/ | head -10

        # Run migrations (PocketBase auto-discovers ./pb_migrations from ./pb_test_data)
        echo "Running migrations..."
        ./pocketbase migrate up --dir ./pb_test_data 2>&1 | tee /tmp/pb_migrate.log

        echo "Starting PocketBase server..."
        ./pocketbase serve --dir ./pb_test_data --http 127.0.0.1:18999 > /tmp/pb_output.log 2>&1 &
        PB_PID=$!

        # Wait for startup (max 30s)
        for i in {1..30}; do
          if curl -sf http://127.0.0.1:18999/api/health >/dev/null 2>&1; then
            echo "✅ PocketBase started successfully - migrations applied"
            break
          fi
          # Check if process died (migration error)
          if ! kill -0 $PB_PID 2>/dev/null; then
            echo "❌ PocketBase crashed during startup - migration error:"
            echo "----------------------------------------"
            cat /tmp/pb_output.log
            echo "----------------------------------------"
            rm -rf ./pb_test_data
            exit 1
          fi
          sleep 1
        done

        # Check if PB is running after timeout
        if ! curl -sf http://127.0.0.1:18999/api/health >/dev/null 2>&1; then
          echo "❌ PocketBase failed to start within 30s:"
          echo "----------------------------------------"
          cat /tmp/pb_output.log
          echo "----------------------------------------"
          kill $PB_PID 2>/dev/null || true
          rm -rf ./pb_test_data
          exit 1
        fi

        # Create temporary superuser via CLI (required for fresh DB in PB v0.23+)
        echo "Creating temporary superuser for schema validation..."
        ./pocketbase superuser upsert ci@test.local ci_test_pass_123 --dir ./pb_test_data

        # Get auth token
        AUTH_TOKEN=$(curl -sf -X POST http://127.0.0.1:18999/api/collections/_superusers/auth-with-password \
          -H "Content-Type: application/json" \
          -d '{"identity":"ci@test.local","password":"ci_test_pass_123"}' \
          | python3 -c "import sys,json; print(json.load(sys.stdin).get('token',''))")

        if [ -z "$AUTH_TOKEN" ]; then
          echo "❌ Failed to authenticate for schema validation"
          kill $PB_PID 2>/dev/null || true
          rm -rf ./pb_test_data
          exit 1
        fi

        # Validate schema via API
        echo "Validating migration schema..."
        curl -sf http://127.0.0.1:18999/api/collections \
          -H "Authorization: Bearer $AUTH_TOKEN" \
          > /tmp/collections.json

        set +e
        python3 ../scripts/ci/validate_migrations.py /tmp/collections.json
        VALIDATION_RESULT=$?
        set -e

        if [ $VALIDATION_RESULT -ne 0 ]; then
          echo "❌ Schema validation failed"
          echo "Migration log:"
          cat /tmp/pb_migrate.log || true
          echo "PocketBase output log:"
          cat /tmp/pb_output.log || true
          # Cleanup
          kill $PB_PID 2>/dev/null || true
          rm -rf ./pb_test_data
          exit 1
        fi

        # Cleanup on success
        kill $PB_PID 2>/dev/null || true
        rm -rf ./pb_test_data

        echo "✅ Migration smoke test passed"

    # Frontend tests - Node.js pre-installed
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Run frontend tests
      working-directory: ./frontend
      run: npm run test -- --run

  # Submit dependencies to GitHub's dependency graph
  # Non-blocking: informational only, GitHub API errors shouldn't fail CI
  dependency-submission:
    name: Dependency Submission
    runs-on: ubuntu-latest
    # Only submit on main branch pushes (not PRs, not other branches)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    continue-on-error: true
    permissions:
      contents: write  # Required for dependency submission API
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Submit dependencies
      uses: advanced-security/component-detection-dependency-submission-action@v0.1.1

  # Summary job - gate for PR merges
  summary:
    name: CI Summary
    needs: [commit-lint, detect-changes, secret-scan, python-lint, go-lint, frontend-lint, docker-lint, tests, dependency-submission]
    if: always()
    runs-on: ubuntu-latest
    steps:
    - name: Check status
      run: |
        # commit-lint is skipped for Dependabot PRs
        if [ "${{ needs.commit-lint.result }}" != "success" ] && [ "${{ needs.commit-lint.result }}" != "skipped" ]; then
          echo "❌ Commit message format invalid! Use: type(scope): description"
          echo "   See CLAUDE.md for allowed scopes."
          exit 1
        fi
        if [ "${{ needs.secret-scan.result }}" != "success" ]; then
          echo "❌ Secret scanning failed! Check for leaked credentials."
          echo "   If these are intentional dev/test values, add them to .gitleaks.toml"
          exit 1
        fi
        # Lint jobs: success or skipped (when no relevant changes)
        if [ "${{ needs.python-lint.result }}" != "success" ] && [ "${{ needs.python-lint.result }}" != "skipped" ]; then
          echo "❌ Python linting/type checks failed!"
          exit 1
        fi
        if [ "${{ needs.go-lint.result }}" != "success" ] && [ "${{ needs.go-lint.result }}" != "skipped" ]; then
          echo "❌ Go linting failed!"
          exit 1
        fi
        if [ "${{ needs.frontend-lint.result }}" != "success" ] && [ "${{ needs.frontend-lint.result }}" != "skipped" ]; then
          echo "❌ Frontend linting/type checks failed!"
          exit 1
        fi
        if [ "${{ needs.docker-lint.result }}" != "success" ] && [ "${{ needs.docker-lint.result }}" != "skipped" ]; then
          echo "❌ Docker linting failed!"
          exit 1
        fi
        if [ "${{ needs.tests.result }}" != "success" ] && [ "${{ needs.tests.result }}" != "skipped" ]; then
          echo "❌ Tests failed!"
          exit 1
        fi
        # dependency-submission is non-blocking (informational only)
        if [ "${{ needs.dependency-submission.result }}" == "failure" ]; then
          echo "⚠️ Dependency submission failed (non-blocking)"
        fi
        echo "✅ All CI checks passed!"
