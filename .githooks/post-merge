#!/bin/bash
# Post-merge hook: Notify about worktrees ready for cleanup
# Runs after `git pull` or `git merge`

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

MAIN_REPO="$(git rev-parse --show-toplevel)"
REPO_NAME="$(basename "$MAIN_REPO")"
REPO_PARENT="$(dirname "$MAIN_REPO")"
WORKTREES_DIR="$REPO_PARENT/${REPO_NAME}-worktrees"

# Only proceed if worktrees directory exists
[ -d "$WORKTREES_DIR" ] || exit 0

# Check if a PR for this branch was merged
is_pr_merged() {
    local branch="$1"
    local state
    state=$(gh pr list --head "$branch" --state merged --json state --jq '.[0].state' 2>/dev/null)
    [ "$state" = "MERGED" ]
}

# Collect worktrees with merged PRs
MERGED_WORKTREES=()

for dir in "$WORKTREES_DIR"/*/; do
    [ -d "$dir" ] || continue
    name=$(basename "$dir")
    branch="feature/$name"

    if is_pr_merged "$branch"; then
        MERGED_WORKTREES+=("$name")
    fi
done

# Report merged worktrees
if [ ${#MERGED_WORKTREES[@]} -gt 0 ]; then
    echo -e ""
    echo -e "${GREEN}Worktrees ready for cleanup (PR merged):${NC}"
    for name in "${MERGED_WORKTREES[@]}"; do
        echo -e "  ${YELLOW}$name${NC}"
    done
    echo -e ""
    if [ ${#MERGED_WORKTREES[@]} -eq 1 ]; then
        echo -e "Run: ./scripts/worktree/cleanup.sh ${MERGED_WORKTREES[0]}"
    else
        echo -e "Run: ./scripts/worktree/cleanup.sh --all-merged"
    fi
    echo -e ""
fi
